name: Automated M365 Security Audit

on:
  # schedule:
  #   # Run monthly on the 1st at 6 AM UTC
  #   - cron: '0 6 1 * *'
  workflow_dispatch:
    inputs:
      audit_scope:
        description: 'Audit scope (full, exchange, sharepoint, purview)'
        required: false
        default: 'full'
        type: choice
        options:
        - full
        - exchange
        - sharepoint
        - purview
      skip_remediation:
        description: 'Skip automated remediation (dry-run only)'
        required: false
        default: true
        type: boolean

permissions:
  contents: read
  id-token: write
  attestations: write
  issues: write

jobs:
  m365-security-audit:
    name: M365 CIS Security Audit
    runs-on: windows-latest

    # Manual trigger only until M365 credentials are configured
    if: ${{ github.event_name == 'workflow_dispatch' }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Configure M365 environment
      shell: pwsh
      env:
        M365_TENANT_ID: ${{ vars.M365_TENANT_ID }}
        M365_CLIENT_ID: ${{ vars.M365_CLIENT_ID }}
      run: |
        Write-Host "ğŸ”§ Configuring M365 environment..."

        # Install required PowerShell modules
        Install-Module -Name ExchangeOnlineManagement -Force -Scope CurrentUser
        Install-Module -Name Microsoft.Graph.Authentication -Force -Scope CurrentUser
        Install-Module -Name Microsoft.Graph.Identity.SignIns -Force -Scope CurrentUser
        Install-Module -Name Microsoft.Graph.Identity.DirectoryManagement -Force -Scope CurrentUser
        Install-Module -Name Microsoft.Online.SharePoint.PowerShell -Force -Scope CurrentUser -AllowClobber

    - name: Run M365 CIS audit
      shell: pwsh
      env:
        M365_TENANT_ID: ${{ vars.M365_TENANT_ID }}
        M365_CLIENT_ID: ${{ vars.M365_CLIENT_ID }}
        M365_CLIENT_SECRET: ${{ secrets.M365_CLIENT_SECRET }}
        AUDIT_SCOPE: ${{ github.event.inputs.audit_scope || 'full' }}
      run: |
        Write-Host "ğŸ›¡ï¸ Starting M365 CIS Security Audit..."

        # Set parameters based on scope
        $scopeParams = @{}
        switch ($env:AUDIT_SCOPE) {
          'exchange' { $scopeParams['ExchangeOnly'] = $true }
          'sharepoint' { $scopeParams['SharePointOnly'] = $true }
          'purview' { $scopeParams['PurviewOnly'] = $true }
          default { Write-Host "Running full audit..." }
        }

        # Run the audit with timestamping
        try {
          ./scripts/powershell/Invoke-M365CISAudit.ps1 -Timestamped @scopeParams
          Write-Host "âœ… Audit completed successfully"
        } catch {
          Write-Host "âŒ Audit failed: $_"
          exit 1
        }

    - name: Generate reports
      shell: pwsh
      run: |
        Write-Host "ğŸ“Š Generating audit reports..."

        # Find the most recent audit file
        $auditFile = Get-ChildItem "output/reports/security/" -Filter "m365_cis_audit_*.json" |
                     Sort-Object LastWriteTime -Descending |
                     Select-Object -First 1

        if ($auditFile) {
          Write-Host "Processing audit file: $($auditFile.Name)"

          # Generate Excel report
          python scripts/m365_cis_report.py --input $auditFile.FullName

          # Generate HTML dashboard
          python scripts/generate_security_dashboard.py --input $auditFile.FullName

          Write-Host "âœ… Reports generated successfully"
        } else {
          Write-Host "âŒ No audit file found"
          exit 1
        }

    - name: Run remediation preview (if enabled)
      if: ${{ !github.event.inputs.skip_remediation }}
      shell: pwsh
      run: |
        Write-Host "ğŸ”§ Running remediation preview..."
        ./scripts/powershell/PostRemediateM365CIS.ps1 -WhatIf

    - name: Upload audit artifacts
      uses: actions/upload-artifact@v4
      id: upload-audit-artifacts
      with:
        name: m365-audit-results-${{ github.run_number }}
        path: |
          output/reports/security/
        retention-days: 90

    - name: Attest audit artifacts
      uses: actions/attest-build-provenance@v2
      with:
        subject-path: output/reports/security/*

    - name: Create audit summary issue
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = require('path');

          // Find the latest audit results
          const securityDir = 'output/reports/security';
          const auditFiles = fs.readdirSync(securityDir)
            .filter(file => file.startsWith('m365_cis_audit_') && file.endsWith('.json'))
            .sort()
            .reverse();

          if (auditFiles.length === 0) {
            console.log('No audit files found');
            return;
          }

          const latestFile = auditFiles[0];
          const auditData = JSON.parse(fs.readFileSync(path.join(securityDir, latestFile), 'utf8'));

          // Count results by status
          const summary = auditData.reduce((acc, control) => {
            acc[control.Status] = (acc[control.Status] || 0) + 1;
            return acc;
          }, {});

          const totalControls = auditData.length;
          const passedControls = summary.Pass || 0;
          const failedControls = summary.Fail || 0;
          const manualControls = summary.Manual || 0;

          const complianceRate = Math.round((passedControls / totalControls) * 100);

          const issueBody = `## ğŸ›¡ï¸ M365 CIS Security Audit Results

          **Audit Date:** ${new Date().toISOString().split('T')[0]}
          **Audit Scope:** ${{ github.event.inputs.audit_scope || 'full' }}
          **Workflow Run:** #${{ github.run_number }}

          ### ğŸ“Š Summary
          - **Total Controls:** ${totalControls}
          - **Passed:** ${passedControls} âœ…
          - **Failed:** ${failedControls} âŒ
          - **Manual Review:** ${manualControls} ğŸ”
          - **Compliance Rate:** ${complianceRate}%

          ### ğŸ¯ Next Actions
          ${failedControls > 0 ? '- Review failed controls and plan remediation' : '- No immediate actions required'}
          ${manualControls > 0 ? '- Complete manual reviews for applicable controls' : ''}

          ### ğŸ“ Artifacts
          - Audit results: \`${latestFile}\`
          - Excel report: Available in workflow artifacts
          - HTML dashboard: Available in workflow artifacts

          ---
          *This issue was automatically created by the M365 Security Audit workflow*`;

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `M365 Security Audit Results - ${new Date().toISOString().split('T')[0]} (${complianceRate}% compliance)`,
            body: issueBody,
            labels: ['audit', 'security', 'automated']
          });

  schedule-next-audit:
    name: Schedule Next Audit Reminder
    runs-on: ubuntu-latest
    needs: [m365-security-audit]
    if: success()

    steps:
    - name: Create reminder issue
      uses: actions/github-script@v6
      with:
        script: |
          const nextAuditDate = new Date();
          nextAuditDate.setMonth(nextAuditDate.getMonth() + 1);

          const issueBody = `## ğŸ—“ï¸ Monthly M365 Security Audit Reminder

          The automated M365 security audit completed successfully.

          **Next Scheduled Audit:** ${nextAuditDate.toISOString().split('T')[0]}

          ### ğŸ“‹ Preparation Checklist
          - [ ] Review previous audit findings
          - [ ] Update CIS benchmark requirements if needed
          - [ ] Verify M365 service principal permissions
          - [ ] Check for new M365 security features to assess

          ### ğŸ”§ Manual Trigger
          To run an ad-hoc audit, go to Actions â†’ "Automated M365 Security Audit" â†’ "Run workflow"

          ---
          *This reminder was automatically created by the audit workflow*`;

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `Next M365 Security Audit - ${nextAuditDate.toISOString().split('T')[0]}`,
            body: issueBody,
            labels: ['audit', 'reminder', 'scheduled']
          });
