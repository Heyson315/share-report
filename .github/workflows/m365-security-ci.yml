name: M365 Security Toolkit CI/CD

on:
  push:
    branches: [ main, develop, feature/*, copilot/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  attestations: write

jobs:
  python-quality-checks:
    name: Python Code Quality & Testing
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'
        cache: 'pip'  # Cache pip dependencies for faster builds

    - name: Cache Python packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: Run performance benchmarks
      run: |
        echo "ðŸš€ Running Performance Benchmarks..."
        python scripts/run_performance_benchmark.py

    - name: Lint Python code with flake8
      run: |
        echo "ðŸ” Linting Python code with flake8..."
        flake8 scripts/ src/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics

    - name: Check code formatting with black
      run: |
        echo "ðŸŽ¨ Checking code formatting with black..."
        black --check scripts/ src/ tests/

    - name: Run Python tests
      run: |
        echo "ðŸ§ª Running Python tests..."
        python -m pytest tests/ -v --cov=src --cov-report=xml

    - name: Upload coverage reports
      uses: codecov/codecov-action@v5
      with:
        file: ./coverage.xml
        fail_ci_if_error: false

  # New: Static type checking with mypy
  python-static-analysis:
    name: Python Static Analysis (mypy & pylint)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Cache Python packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-static-${{ hashFiles('requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        pip install mypy pylint types-requests

    - name: Run mypy type checking
      run: |
        echo "ðŸ”¬ Running mypy static type checking..."
        mypy src/ scripts/ --ignore-missing-imports --no-strict-optional --show-error-codes 2>&1 | tee mypy-output.txt
        # Allow failures for now as this is informational
        exit 0

    - name: Run pylint deep analysis
      run: |
        echo "ðŸ” Running pylint deep static analysis..."
        pylint src/ scripts/ --rcfile=.pylintrc --output-format=text --reports=yes 2>&1 | tee pylint-output.txt
        # Allow failures for now as this is informational
        exit 0

    - name: Generate static analysis report
      if: always()
      run: |
        echo "## ðŸ“Š Static Analysis Report" > static-analysis-report.md
        echo "" >> static-analysis-report.md
        echo "### mypy Type Checking" >> static-analysis-report.md
        echo '```' >> static-analysis-report.md
        cat mypy-output.txt >> static-analysis-report.md || echo "mypy output not available" >> static-analysis-report.md
        echo '```' >> static-analysis-report.md
        echo "" >> static-analysis-report.md
        echo "### pylint Analysis" >> static-analysis-report.md
        echo '```' >> static-analysis-report.md
        cat pylint-output.txt >> static-analysis-report.md || echo "pylint output not available" >> static-analysis-report.md
        echo '```' >> static-analysis-report.md

    - name: Upload static analysis report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: static-analysis-report
        path: static-analysis-report.md
        retention-days: 30

  powershell-security-checks:
    name: PowerShell Security & Quality
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install PowerShell modules
      shell: pwsh
      run: |
        Write-Host "ðŸ“¦ Installing PowerShell modules..."
        Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
        Install-Module -Name Pester -Force -Scope CurrentUser -SkipPublisherCheck

    - name: Analyze PowerShell scripts
      shell: pwsh
      run: |
        Write-Host "ðŸ” Analyzing PowerShell scripts..."
        $results = Invoke-ScriptAnalyzer -Path "scripts/powershell/" -Settings ".PSScriptAnalyzerSettings.psd1" -Recurse
        if ($results) {
          $results | Format-Table -AutoSize
          Write-Host "âŒ PowerShell script analysis found issues"
          exit 1
        } else {
          Write-Host "âœ… PowerShell scripts passed analysis"
        }

    - name: Test PowerShell modules
      shell: pwsh
      run: |
        Write-Host "ðŸ§ª Testing PowerShell modules..."
        # Test if M365CIS module loads without errors
        try {
          Import-Module "./scripts/powershell/modules/M365CIS.psm1" -Force
          Write-Host "âœ… M365CIS module imported successfully"
        } catch {
          Write-Host "âŒ Failed to import M365CIS module: $_"
          exit 1
        }

    - name: Run Pester unit tests
      shell: pwsh
      run: |
        Write-Host "ðŸ§ª Running Pester unit tests..."
        # Check if Pester tests exist
        $testPath = "tests/powershell"
        if (Test-Path $testPath) {
          $config = New-PesterConfiguration
          $config.Run.Path = $testPath
          $config.Output.Verbosity = 'Detailed'
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputPath = "pester-results.xml"
          $config.TestResult.OutputFormat = 'NUnitXml'
          $results = Invoke-Pester -Configuration $config
          if ($results.FailedCount -gt 0) {
            Write-Host "âŒ Pester tests failed: $($results.FailedCount) failures"
            exit 1
          } else {
            Write-Host "âœ… All Pester tests passed: $($results.PassedCount) tests"
          }
        } else {
          Write-Host "âš ï¸ No Pester tests found in $testPath - creating placeholder"
          # Create test directory for future tests
          New-Item -ItemType Directory -Path $testPath -Force | Out-Null
          Write-Host "âœ… Pester test directory created"
        }

    - name: Upload Pester test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: pester-results
        path: pester-results.xml
        if-no-files-found: ignore

  security-vulnerability-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'

    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit semgrep pip-audit

    - name: Check Python dependencies for vulnerabilities with safety
      run: |
        echo "ðŸ” Scanning Python dependencies with safety..."
        safety check --json --output safety-report.json || true
        if [ -s safety-report.json ]; then
          echo "âš ï¸ Security vulnerabilities found in dependencies!"
          cat safety-report.json
        else
          echo "âœ… No vulnerabilities found by safety"
        fi

    - name: Check Python dependencies with pip-audit (redundant check)
      run: |
        echo "ðŸ” Scanning Python dependencies with pip-audit (redundant check)..."
        pip-audit --format=json --output=pip-audit-report.json || true
        if [ -s pip-audit-report.json ] && [ "$(cat pip-audit-report.json)" != "[]" ]; then
          echo "âš ï¸ Security vulnerabilities found by pip-audit!"
          cat pip-audit-report.json
        else
          echo "âœ… No vulnerabilities found by pip-audit"
        fi

    - name: Run bandit security linter
      run: |
        echo "ðŸ” Running bandit security analysis..."
        bandit -r scripts/ src/ -f json -o bandit-report.json || true
        if [ -s bandit-report.json ] && [ "$(jq '.results | length' bandit-report.json)" -gt 0 ]; then
          echo "âš ï¸ Security issues found by bandit!"
          jq '.results' bandit-report.json
        else
          echo "âœ… No security issues found by bandit"
        fi

    - name: Run semgrep advanced security scanning
      run: |
        echo "ðŸ” Running semgrep advanced security scanning..."
        semgrep scan --config=auto --json --output=semgrep-report.json scripts/ src/ || true
        if [ -s semgrep-report.json ] && [ "$(jq '.results | length' semgrep-report.json 2>/dev/null)" -gt 0 ]; then
          echo "âš ï¸ Security issues found by semgrep!"
          jq '.results[] | {path: .path, message: .extra.message, severity: .extra.severity}' semgrep-report.json 2>/dev/null || cat semgrep-report.json
        else
          echo "âœ… No security issues found by semgrep"
        fi

    - name: Upload security reports
      uses: actions/upload-artifact@v4
      id: upload-security-reports
      if: always()
      with:
        name: security-reports
        path: |
          safety-report.json
          pip-audit-report.json
          bandit-report.json
          semgrep-report.json

    - name: Attest security reports
      uses: actions/attest-build-provenance@v3
      if: always()
      with:
        subject-path: |
          safety-report.json
          bandit-report.json

  documentation-checks:
    name: Documentation & Markdown Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install markdown tools
      run: |
        npm install -g markdownlint-cli markdown-link-check

    - name: Lint Markdown files
      run: |
        echo "ðŸ“ Linting Markdown files..."
        markdownlint docs/ *.md --config .markdownlint.json || true

    - name: Check Markdown links
      run: |
        echo "ðŸ”— Checking Markdown links..."
        find . -name "*.md" -not -path "./node_modules/*" -not -path "./.git/*" | \
        xargs -I {} markdown-link-check {} --config .markdown-link-check.json || true

  integration-tests:
    name: M365 Integration Tests (Simulation)
    runs-on: ubuntu-latest
    needs: [python-quality-checks]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Test CSV processing pipeline
      run: |
        echo "ðŸ“Š Testing CSV processing pipeline..."
        # Create test data
        mkdir -p data/test
        echo "Site Name,Site URL,Principal Name,Permission Level" > data/test/test_input.csv
        echo "Test Site,https://test.sharepoint.com,user@test.com,Read" >> data/test/test_input.csv

        # Test cleaning
        python scripts/clean_csv.py --input data/test/test_input.csv --output data/test/test_clean.csv

        # Verify output
        if [ -f data/test/test_clean.csv ]; then
          echo "âœ… CSV processing pipeline works"
        else
          echo "âŒ CSV processing pipeline failed"
          exit 1
        fi

    - name: Test JSON report generation simulation
      run: |
        echo "ðŸ“‹ Testing JSON report generation..."
        python scripts/generate_security_dashboard.py --input data/raw/sample_audit.json --output output/test_dashboard.html || true
        echo "âœ… Report generation simulation completed"

  build-summary:
    name: Build Summary
    permissions:
      contents: read
    runs-on: ubuntu-latest
    needs: [python-quality-checks, python-static-analysis, powershell-security-checks, security-vulnerability-scan, documentation-checks, integration-tests]
    if: always()

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Generate build summary
      run: |
        echo "## ðŸŽ¯ M365 Security Toolkit Build Summary" > build-summary.md
        echo "" >> build-summary.md
        echo "### Build Status:" >> build-summary.md
        echo "- **Python Quality**: ${{ needs.python-quality-checks.result }}" >> build-summary.md
        echo "- **Python Static Analysis (mypy & pylint)**: ${{ needs.python-static-analysis.result }}" >> build-summary.md
        echo "- **PowerShell Security & Pester Tests**: ${{ needs.powershell-security-checks.result }}" >> build-summary.md
        echo "- **Security Scan (bandit, safety, pip-audit, semgrep)**: ${{ needs.security-vulnerability-scan.result }}" >> build-summary.md
        echo "- **Documentation**: ${{ needs.documentation-checks.result }}" >> build-summary.md
        echo "- **Integration Tests**: ${{ needs.integration-tests.result }}" >> build-summary.md
        echo "" >> build-summary.md
        echo "### ðŸ›¡ï¸ Security Features Validated:" >> build-summary.md
        echo "- M365 CIS Benchmark compliance checks" >> build-summary.md
        echo "- SharePoint permissions analysis" >> build-summary.md
        echo "- Performance benchmarking capabilities" >> build-summary.md
        echo "- Automated security reporting" >> build-summary.md
        echo "" >> build-summary.md
        echo "### ðŸ”’ Redundant Security Checks:" >> build-summary.md
        echo "- **Dependency Scanning**: safety + pip-audit" >> build-summary.md
        echo "- **Code Security**: bandit + semgrep" >> build-summary.md
        echo "- **Static Analysis**: flake8 + pylint + mypy" >> build-summary.md
        echo "- **PowerShell**: PSScriptAnalyzer + Pester" >> build-summary.md
        echo "" >> build-summary.md
        echo "Generated at: $(date)" >> build-summary.md

        cat build-summary.md

    - name: Upload build summary
      uses: actions/upload-artifact@v4
      id: upload-build-summary
      with:
        name: build-summary
        path: build-summary.md

    - name: Attest build summary
      uses: actions/attest-build-provenance@v3
      with:
        subject-path: build-summary.md
