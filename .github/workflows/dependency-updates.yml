name: Dependency Updates

on:
  schedule:
    # Run weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  update-python-dependencies:
    name: Update Python Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install pip-tools
      run: |
        python -m pip install --upgrade pip
        pip install pip-tools

    - name: Update requirements.txt
      run: |
        pip-compile --upgrade --output-file requirements.txt
        pip-compile --upgrade --output-file requirements-dev.txt

    - name: Check for security vulnerabilities
      run: |
        pip install safety
        safety check --json --output safety-report.json || true
        
        # Check if there are vulnerabilities
        if [ -s safety-report.json ]; then
          echo "Security vulnerabilities found!"
          cat safety-report.json
          echo "SECURITY_ISSUES=true" >> $GITHUB_ENV
        else
          echo "No security vulnerabilities found."
          echo "SECURITY_ISSUES=false" >> $GITHUB_ENV
        fi

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore: update Python dependencies"
        title: "ðŸ”„ Weekly Dependency Updates"
        body: |
          ## ðŸ“¦ Dependency Updates
          
          This PR contains weekly dependency updates generated automatically.
          
          ### Changes:
          - Updated Python dependencies to latest versions
          - Security scan results: ${{ env.SECURITY_ISSUES == 'true' && 'âš ï¸ Issues found' || 'âœ… No issues' }}
          
          ### Security Status:
          ${{ env.SECURITY_ISSUES == 'true' && 'ðŸ” Please review safety-report.json for security vulnerabilities' || 'ðŸ”’ All dependencies are secure' }}
          
          ### Next Steps:
          1. Review the changes
          2. Run tests to ensure compatibility
          3. Merge if all checks pass
          
          ---
          *This PR was created automatically by the dependency update workflow.*
        branch: chore/dependency-updates
        delete-branch: true
      if: success()

  update-github-actions:
    name: Update GitHub Actions
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Update GitHub Actions
      uses: dotenv-linter/github-action-dotenv-linter@v2
      with:
        reporter: github-pr-review
      continue-on-error: true

    - name: Check for action updates
      run: |
        echo "Checking for GitHub Actions updates..."
        # This could be enhanced with a tool like renovate or dependabot
        grep -r "uses:" .github/workflows/ | grep -o "@v[0-9]*" | sort | uniq > current-versions.txt
        echo "Current action versions:"
        cat current-versions.txt

  security-advisory-check:
    name: Security Advisory Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Run GitHub Advisory Database check
      run: |
        # Check if there are any security advisories for our dependencies
        pip install pip-audit
        pip-audit --desc --output=audit-report.json --format=json || true
        
        if [ -s audit-report.json ]; then
          echo "ðŸš¨ Security advisories found!"
          echo "ADVISORIES_FOUND=true" >> $GITHUB_ENV
        else
          echo "âœ… No security advisories found."
          echo "ADVISORIES_FOUND=false" >> $GITHUB_ENV
        fi

    - name: Create security issue
      if: env.ADVISORIES_FOUND == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const auditReport = JSON.parse(fs.readFileSync('audit-report.json', 'utf8'));
          
          const body = `## ðŸš¨ Security Advisory Alert
          
          Automated security scan found potential vulnerabilities in dependencies.
          
          ### Details:
          \`\`\`json
          ${JSON.stringify(auditReport, null, 2)}
          \`\`\`
          
          ### Next Steps:
          1. Review the vulnerabilities above
          2. Update affected dependencies
          3. Test for compatibility
          4. Deploy security fixes
          
          ### Priority:
          ðŸ”´ High - Security vulnerabilities require immediate attention
          
          ---
          *This issue was created automatically by the security monitoring workflow.*`;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ðŸš¨ Security Advisory: Vulnerabilities detected in dependencies`,
            body: body,
            labels: ['security', 'high-priority', 'dependencies']
          });